<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Game</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
body{
  background:#f4f6fb;
}

/* Progress */
.sublevel{
  height:8px;
  border-radius:20px;
  background:#ddd;
  flex-grow:1;
}
.sublevel.active{
  background:#4caf50;
}

/* Question */
.question-card{
  min-height:120px;
}

/* Inputs */
.input-box{
  width:45px;
  height:55px;
  font-size:22px;
  text-align:center;
}

/* Buttons */
.nav-btn{
  width:40px;
  height:40px;
  border-radius:50%;
}
</style>
</head>

<body>

<header class="p-2 bg-white shadow-sm d-flex align-items-center">
  <button onclick="history.back()" class="btn btn-light">
    <i class="bi bi-arrow-left"></i>
  </button>
  <h6 id="title" class="mx-auto mb-0"></h6>
</header>

<main class="container py-3">

<!-- LEVEL + SUBLEVEL -->
<section>
  <div class="d-flex justify-content-between mb-2">
    <span id="levelLabel"></span>
    <span id="nextLevel"></span>
  </div>

  <div id="subProgress" class="d-flex gap-2"></div>
</section>

<!-- QUESTIONS -->
<section class="card question-card p-3 my-3 text-center">
  <p id="questionText" class="fw-semibold"></p>
</section>

<!-- SLIDE BUTTONS -->
<section class="d-flex justify-content-between mb-3">
  <button class="btn btn-light nav-btn" onclick="prevQ()">
    <i class="bi bi-chevron-left"></i>
  </button>

  <button class="btn btn-light nav-btn" onclick="nextQ()">
    <i class="bi bi-chevron-right"></i>
  </button>
</section>

<!-- INPUT -->
<section id="inputs" class="d-flex justify-content-center gap-2 mb-3"></section>

<button class="btn btn-success w-100" onclick="submitAnswer()">Submit</button>

</main>

<script>
const url=new URLSearchParams(location.search);
let level=parseInt(url.get("level"));
let sub=parseInt(url.get("sub"));

let gameData, subData, answer="";
let qIndex=0;

fetch("data.json")
.then(res=>res.json())
.then(data=>{
  gameData=data;

  let lvl=data.levels.find(l=>l.level===level);
  subData=lvl.sublevels.find(s=>s.sub===sub);

  document.getElementById("title").innerText=`Level ${level}`;
  document.getElementById("levelLabel").innerText=`Level ${level}`;
  document.getElementById("nextLevel").innerText=`Level ${level+1}`;

  answer=subData.answer.toUpperCase();

  buildSublevels(lvl);
  loadQuestion();
  buildInputs();
});

/* Sublevel progress */
function buildSublevels(lvl){
  let html="";
  lvl.sublevels.forEach(s=>{
    html+=`<div class="sublevel ${s.sub<=sub?'active':''}"></div>`;
  });
  document.getElementById("subProgress").innerHTML=html;
}

/* Question slider */
function loadQuestion(){
  document.getElementById("questionText").innerText=subData.questions[qIndex];
}

function nextQ(){
  if(qIndex < subData.questions.length-1){
    qIndex++;
    loadQuestion();
  }
}

function prevQ(){
  if(qIndex>0){
    qIndex--;
    loadQuestion();
  }
}

/* Inputs */
function buildInputs(){
  let html="";
  for(let i=0;i<answer.length;i++){
    html+=`<input maxlength="1" class="form-control input-box">`;
  }
  document.getElementById("inputs").innerHTML=html;
}

/* Submit */
function submitAnswer(){
  let user="";
  document.querySelectorAll(".input-box").forEach(i=>{
    user+=i.value.toUpperCase();
  });

  if(user===answer){
    saveProgress();
    nextStep();
  }else{
    alert("Wrong answer");
  }
}

/* Save */
function saveProgress(){
  let progress=JSON.parse(localStorage.getItem("progress"))||{};
  if(!progress["level"+level])progress["level"+level]={};
  progress["level"+level]["sub"+sub]=true;
  localStorage.setItem("progress",JSON.stringify(progress));
}

/* Next */
function nextStep(){
  let lvl=gameData.levels.find(l=>l.level===level);

  if(sub<lvl.sublevels.length){
    location.href=`game.html?level=${level}&sub=${sub+1}`;
  }else{
    let progress=JSON.parse(localStorage.getItem("progress"))||{};
    progress["level"+level]=true;
    localStorage.setItem("progress",JSON.stringify(progress));
    location.href="index.html";
  }
}
</script>

</body>
</html>

